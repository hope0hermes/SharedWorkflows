# Reusable Release Workflow
#
# This workflow automates version bumping and release creation.
# It analyzes commit messages, bumps the version, updates CHANGELOG, and creates a PR.
#
# Usage:
#   jobs:
#     release:
#       uses: hope0hermes/SharedWorkflows/.github/workflows/reusable-release.yml
#       with:
#         package-path: "src/my_package/__init__.py"
#       secrets:
#         PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

name: Reusable Release

on:
  workflow_call:
    inputs:
      package-path:
        description: 'Path to package __init__.py (e.g., src/strava_analyzer/__init__.py)'
        required: true
        type: string
    
    secrets:
      PAT_TOKEN:
        description: 'Personal Access Token with repo and pull_request scopes'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Check skip conditions
        id: skip_check
        uses: hope0hermes/SharedWorkflows/actions/check-skip-conditions@main
      
      - name: Determine version bump type
        if: steps.skip_check.outputs.should_skip != 'true'
        id: bump_type
        uses: hope0hermes/SharedWorkflows/actions/determine-version-bump@main
      
      - name: Bump version
        if: steps.skip_check.outputs.should_skip != 'true' && steps.bump_type.outputs.bump_type != 'none'
        id: version
        uses: hope0hermes/SharedWorkflows/actions/bump-version@main
        with:
          bump-type: ${{ steps.bump_type.outputs.bump_type }}
      
      - name: Update changelog
        if: steps.skip_check.outputs.should_skip != 'true' && steps.bump_type.outputs.bump_type != 'none'
        uses: hope0hermes/SharedWorkflows/actions/update-changelog@main
        with:
          version: ${{ steps.version.outputs.new_version }}
          commits: ${{ steps.bump_type.outputs.commits }}
      
      - name: Regenerate lock file (if using uv)
        if: steps.skip_check.outputs.should_skip != 'true' && steps.bump_type.outputs.bump_type != 'none'
        shell: bash
        run: |
          if [ -f "uv.lock" ]; then
            echo "Regenerating uv.lock..."
            pip install uv
            uv lock
            echo "âœ“ Lock file updated"
          fi
      
      - name: Create version bump PR
        if: steps.skip_check.outputs.should_skip != 'true' && steps.bump_type.outputs.bump_type != 'none'
        uses: hope0hermes/SharedWorkflows/actions/create-version-pr@main
        with:
          version: ${{ steps.version.outputs.new_version }}
          package-path: ${{ inputs.package-path }}
          github-token: ${{ secrets.PAT_TOKEN }}
